<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...</text>
  </view>

  <!-- æŠ¥å‘Šå†…å®¹ -->
  <view class="report-content" wx:if="{{!loading && currentReport}}">
    <!-- æŠ¥å‘Šå¤´éƒ¨ -->
    <view class="report-header card">
      <view class="header-top">
        <view class="report-title">
          <text class="title-icon">ğŸ“Š</text>
          <text class="title-text">å­¦ä¹ å‘¨æŠ¥</text>
        </view>
        <view class="header-actions">
          <text class="action-btn" bindtap="toggleHistory">å†å²</text>
          <text class="action-btn" bindtap="regenerateReport">åˆ·æ–°</text>
        </view>
      </view>
      <view class="week-info">
        <text class="week-range">{{formatDate(currentReport.weekRange.start)}} - {{formatDate(currentReport.weekRange.end)}}</text>
        <text class="week-number">ç¬¬{{currentReport.weekRange.weekNumber}}å‘¨</text>
      </view>
    </view>

    <!-- æ ¸å¿ƒç»Ÿè®¡ -->
    <view class="stats-overview card">
      <view class="stats-title">ğŸ“ˆ æœ¬å‘¨æ•°æ®</view>
      <view class="stats-grid">
        <view class="stat-card">
          <view class="stat-icon">â±ï¸</view>
          <view class="stat-value" style="color: {{themeColor}}">{{currentReport.stats.totalMinutes}}</view>
          <view class="stat-label">ä¸“æ³¨åˆ†é’Ÿ</view>
        </view>
        <view class="stat-card">
          <view class="stat-icon">ğŸ¯</view>
          <view class="stat-value" style="color: {{themeColor}}">{{currentReport.stats.totalSessions}}</view>
          <view class="stat-label">ä¸“æ³¨æ¬¡æ•°</view>
        </view>
        <view class="stat-card">
          <view class="stat-icon">âœ…</view>
          <view class="stat-value" style="color: {{themeColor}}">{{currentReport.stats.completedTasks}}</view>
          <view class="stat-label">å®Œæˆä»»åŠ¡</view>
        </view>
        <view class="stat-card">
          <view class="stat-icon">ğŸ“…</view>
          <view class="stat-value" style="color: {{themeColor}}">{{currentReport.stats.activeDays}}</view>
          <view class="stat-label">æ´»è·ƒå¤©æ•°</view>
        </view>
      </view>
      
      <!-- ä¸€è‡´æ€§æŒ‡æ ‡ -->
      <view class="consistency-indicator">
        <view class="consistency-label">å­¦ä¹ ä¸€è‡´æ€§</view>
        <view class="consistency-bar">
          <view class="consistency-fill" 
                style="width: {{currentReport.stats.consistency}}%; background-color: {{themeColor}}">
          </view>
        </view>
        <view class="consistency-value" style="color: {{themeColor}}">{{currentReport.stats.consistency}}%</view>
      </view>
    </view>

    <!-- æ¯æ—¥åˆ†å¸ƒ -->
    <view class="daily-distribution card">
      <view class="section-title">ğŸ“Š æ¯æ—¥åˆ†å¸ƒ</view>
      <view class="daily-chart">
        <view class="daily-item" 
              wx:for="{{currentReport.stats.dailyStats}}" 
              wx:for-item="dayData"
              wx:key="date">
          <view class="day-name">{{dayData.dayName}}</view>
          <view class="day-bar">
            <view class="day-fill" 
                  style="height: {{dayData.minutes > 0 ? (dayData.minutes / currentReport.stats.bestDay.minutes * 100) : 0}}%; background-color: {{themeColor}}">
            </view>
          </view>
          <view class="day-minutes">{{dayData.minutes}}åˆ†</view>
        </view>
      </view>
    </view>

    <!-- æˆå°±å±•ç¤º -->
    <view class="achievements-section card" wx:if="{{currentReport.achievements.length > 0}}">
      <view class="section-title">ğŸ† æœ¬å‘¨æˆå°±</view>
      <view class="achievements-list">
        <view class="achievement-item" 
              wx:for="{{currentReport.achievements}}" 
              wx:key="title">
          <view class="achievement-icon">{{item.icon}}</view>
          <view class="achievement-content">
            <view class="achievement-title">{{item.title}}</view>
            <view class="achievement-desc">{{item.description}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- å­¦ä¹ æ´å¯Ÿ -->
    <view class="insights-section card" wx:if="{{currentReport.insights.length > 0}}">
      <view class="section-title">ğŸ’¡ å­¦ä¹ æ´å¯Ÿ</view>
      <view class="insights-list">
        <view class="insight-item {{item.type}}" 
              wx:for="{{currentReport.insights}}" 
              wx:key="title">
          <view class="insight-indicator"></view>
          <view class="insight-content">
            <view class="insight-title">{{item.title}}</view>
            <view class="insight-text">{{item.content}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ”¹è¿›å»ºè®® -->
    <view class="recommendations-section card" wx:if="{{currentReport.recommendations.length > 0}}">
      <view class="section-title">ğŸŒŸ æ”¹è¿›å»ºè®®</view>
      <view class="recommendations-list">
        <view class="recommendation-item" 
              wx:for="{{currentReport.recommendations}}" 
              wx:key="title">
          <view class="recommendation-icon">{{item.icon}}</view>
          <view class="recommendation-content">
            <view class="recommendation-title">{{item.title}}</view>
            <view class="recommendation-text">{{item.content}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- åˆ†äº«æŒ‰é’® -->
    <view class="share-section">
      <button class="share-btn" 
              style="background-color: {{themeColor}}" 
              bindtap="shareReport">
        <text class="share-icon">ğŸ“¤</text>
        <text class="share-text">ç”Ÿæˆåˆ†äº«æµ·æŠ¥</text>
      </button>
    </view>
  </view>

  <!-- å†å²æŠ¥å‘Šå¼¹çª— -->
  <view class="history-overlay {{showHistory ? 'show' : ''}}" wx:if="{{showHistory}}" bindtap="toggleHistory">
    <view class="history-panel" catchtap="doNothing">
      <view class="history-header">
        <text class="history-title">å†å²æŠ¥å‘Š</text>
        <text class="history-close" bindtap="toggleHistory">âœ•</text>
      </view>
      <scroll-view class="history-list" scroll-y>
        <view class="history-item" 
              wx:for="{{historyReports}}" 
              wx:key="id"
              data-report-id="{{item.id}}"
              bindtap="selectHistoryReport">
          <view class="history-date">{{formatDate(item.weekRange.start)}} - {{formatDate(item.weekRange.end)}}</view>
          <view class="history-stats">
            <text class="history-stat">{{item.stats.totalMinutes}}åˆ†é’Ÿ</text>
            <text class="history-stat">{{item.stats.activeDays}}å¤©</text>
          </view>
        </view>
        <view class="history-empty" wx:if="{{historyReports.length === 0}}">
          <text>æš‚æ— å†å²æŠ¥å‘Š</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- éšè—çš„ç”»å¸ƒç”¨äºç”Ÿæˆåˆ†äº«å›¾ç‰‡ -->
  <canvas type="2d" id="shareCanvas" class="share-canvas"></canvas>
</view>

<wxs module="utils">
  var formatDate = function(dateStr) {
    var date = getDate(dateStr);
    return (date.getMonth() + 1) + 'æœˆ' + date.getDate() + 'æ—¥';
  };
  
  module.exports = {
    formatDate: formatDate
  };
</wxs>
