<view class="container" style="--theme-color: {{themeColor}}">
  <view class="header">
    <navigator url="/pages/settings/settings" open-type="navigateBack" hover-class="none">
      <view class="back-icon">
        <text>â†</text>
      </view>
    </navigator>
    <text class="title">æˆå°±ç³»ç»Ÿ</text>
  </view>

  <!-- ç”¨æˆ·ç­‰çº§ä¿¡æ¯ -->
  <view class="level-card">
    <view class="level-info">
      <view class="level-badge" style="background-color: {{themeColor}}">
        <text class="level-text">Lv.{{userLevel}}</text>
      </view>
      <view class="level-details">
        <view class="level-title">ä¸“æ³¨ç­‰çº§</view>
        <view class="exp-info">{{currentExp}}/{{nextLevelExp}} EXP</view>
      </view>
    </view>
    <view class="exp-bar">
      <view class="exp-progress" 
            style="width: {{(currentExp/nextLevelExp*100)}}%; background-color: {{themeColor}}"></view>
    </view>
  </view>

  <!-- ç»Ÿè®¡æ•°æ® -->
  <view class="stats-grid">
    <view class="stat-item">
      <view class="stat-value">{{totalSessions}}</view>
      <view class="stat-label">ä¸“æ³¨æ¬¡æ•°</view>
    </view>
    <view class="stat-item">
      <view class="stat-value">{{utils.formatTime(totalFocusTime)}}</view>
      <view class="stat-label">ä¸“æ³¨æ—¶é•¿</view>
    </view>
    <view class="stat-item">
      <view class="stat-value">{{currentStreak}}</view>
      <view class="stat-label">å½“å‰è¿å‡»</view>
    </view>
    <view class="stat-item">
      <view class="stat-value">{{maxStreak}}</view>
      <view class="stat-label">æœ€é«˜è¿å‡»</view>
    </view>
  </view>

  <!-- æˆå°±åˆ†ç±» -->
  <view class="category-tabs">
    <block wx:for="{{categories}}" wx:key="id">
      <view class="category-tab {{currentCategory === item.id ? 'active' : ''}}"
            style="{{currentCategory === item.id ? 'color: ' + themeColor + '; border-color: ' + themeColor : ''}}"
            bindtap="switchCategory"
            data-id="{{item.id}}">
        <text class="category-name">{{item.name}}</text>
        <text class="category-count">({{item.count}})</text>
      </view>
    </block>
  </view>

  <!-- æˆå°±åˆ—è¡¨ -->
  <view class="achievements-list">
    <block wx:for="{{utils.getFilteredAchievements(achievements, currentCategory)}}" wx:key="id">
      <view class="achievement-item {{item.unlocked ? 'unlocked' : 'locked'}}">
        <view class="achievement-icon {{item.unlocked ? 'unlocked' : ''}}">
          {{item.icon}}
        </view>
        <view class="achievement-info">
          <view class="achievement-title">{{item.title}}</view>
          <view class="achievement-description">{{item.description}}</view>
          <view class="achievement-progress">
            <view class="progress-bar">
              <view class="progress-fill" 
                    style="width: {{(item.progress/item.target*100)}}%; background-color: {{themeColor}}"></view>
            </view>
            <view class="progress-text">{{item.progress}}/{{item.target}}</view>
          </view>
        </view>
        <view class="achievement-status">
          <view class="status-badge {{item.unlocked ? 'unlocked' : 'locked'}}"
                style="{{item.unlocked ? 'background-color: ' + themeColor : ''}}">
            {{item.unlocked ? 'âœ“' : 'ğŸ”’'}}
          </view>
        </view>
      </view>
    </block>
  </view>

  <view class="tips" wx:if="{{utils.getFilteredAchievements(achievements, currentCategory).length === 0}}">
    <view class="tips-icon">ğŸ¯</view>
    <view class="tips-text">æš‚æ— {{currentCategory === 'unlocked' ? 'å·²è§£é”' : 'æœªè§£é”'}}çš„æˆå°±</view>
  </view>
</view>

<wxs module="utils">
  var formatTime = function(minutes) {
    var hours = Math.floor(minutes / 60);
    var mins = minutes % 60;
    if (hours > 0) {
      return hours + 'å°æ—¶' + mins + 'åˆ†é’Ÿ';
    }
    return mins + 'åˆ†é’Ÿ';
  };
  
  var getFilteredAchievements = function(achievements, currentCategory) {
    if (currentCategory === 'unlocked') {
      return achievements.filter(function(a) { return a.unlocked; });
    } else if (currentCategory === 'locked') {
      return achievements.filter(function(a) { return !a.unlocked; });
    }
    return achievements;
  };
  
  module.exports = {
    formatTime: formatTime,
    getFilteredAchievements: getFilteredAchievements
  };
</wxs>
