<view class="container" style="--theme-color: {{themeColor}}">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <view class="loading-text">æ­£åœ¨åŠ è½½å¤ä¹ å†…å®¹...</view>
  </view>

  <!-- å¤ä¹ å†…å®¹ -->
  <view class="review-content" wx:if="{{!loading && !isCompleted}}">
    <!-- å¤´éƒ¨è¿›åº¦ -->
    <view class="review-header">
      <view class="progress-info">
        <view class="progress-text">{{reviewProgress.current}} / {{reviewProgress.total}}</view>
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{(reviewProgress.current / reviewProgress.total) * 100}}%"></view>
        </view>
      </view>
      <view class="header-actions">
        <!-- ç§‘ç›®é€‰æ‹©æŒ‰é’® -->
        <view class="subject-selector-btn" bindtap="showSubjectSelector">
          <text class="subject-icon">ğŸ“š</text>
          <text class="subject-text">{{selectedSubject === 'all' ? 'å…¨éƒ¨ç§‘ç›®' : selectedSubject}}</text>
          <text class="dropdown-icon">â–¼</text>
        </view>
        <view class="exit-btn" bindtap="exitReview">
          <text class="exit-icon">âœ•</text>
        </view>
      </view>
    </view>

    <!-- é¢˜ç›®å†…å®¹ -->
    <view class="question-container" wx:if="{{currentMistake}}">
      <!-- é¢˜ç›®ä¿¡æ¯ -->
      <view class="question-info">
        <view class="question-meta">
          <text class="subject-tag" style="background-color: {{currentMistake.subjectColor}}">{{currentMistake.subject}}</text>
          <text class="chapter-tag" wx:if="{{currentMistake.chapter}}">{{currentMistake.chapter}}</text>
          <text class="difficulty-tag difficulty-{{currentMistake.difficulty}}">{{currentMistake.difficultyText}}</text>
        </view>
      </view>

      <!-- é¢˜ç›®å†…å®¹ -->
      <view class="question-content">
        <view class="question-title">é¢˜ç›®</view>
        <view class="question-text">{{currentMistake.question}}</view>

        <!-- é¢˜ç›®å›¾ç‰‡ -->
        <view class="question-image" wx:if="{{currentMistake.questionImage && currentMistake.questionImage !== ''}}" bindtap="previewImage">
          <image src="{{currentMistake.questionImage}}" mode="widthFix" />
        </view>
      </view>

      <!-- ç”¨æˆ·ç­”æ¡ˆè¾“å…¥ -->
      <view class="answer-input-section" wx:if="{{!showAnswer}}">
        <view class="section-title">ä½ çš„ç­”æ¡ˆ</view>
        <textarea
          class="answer-input"
          placeholder="è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ..."
          value="{{userAnswer}}"
          bindinput="onAnswerInput"
          maxlength="500"
        ></textarea>
      </view>

      <!-- æ ‡å‡†ç­”æ¡ˆ -->
      <view class="answer-section" wx:if="{{showAnswer}}">
        <view class="section-title">æ ‡å‡†ç­”æ¡ˆ</view>

        <!-- ç­”æ¡ˆå›¾ç‰‡ -->
        <view class="answer-image" wx:if="{{currentMistake.answerImage && currentMistake.answerImage !== ''}}" bindtap="previewAnswerImage">
          <image src="{{currentMistake.answerImage}}" mode="widthFix" />
        </view>

        <!-- æ–‡å­—ç­”æ¡ˆ -->
        <view class="answer-content" wx:if="{{currentMistake.correctAnswer || currentMistake.answer}}">
          {{currentMistake.correctAnswer || currentMistake.answer}}
        </view>
      </view>

      <!-- è§£æ -->
      <view class="explanation-section" wx:if="{{showExplanation && currentMistake.explanation}}">
        <view class="section-title">è§£æ</view>
        <view class="explanation-content">{{currentMistake.explanation}}</view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="action-buttons">
        <!-- æœªæ˜¾ç¤ºç­”æ¡ˆæ—¶çš„æŒ‰é’® -->
        <view class="button-group" wx:if="{{!showAnswer}}">
          <button class="action-btn secondary" bindtap="showAnswer">æŸ¥çœ‹ç­”æ¡ˆ</button>
          <button class="action-btn secondary" bindtap="skipQuestion">è·³è¿‡</button>
        </view>

        <!-- æ˜¾ç¤ºç­”æ¡ˆåçš„æŒ‰é’® -->
        <view class="button-group" wx:if="{{showAnswer}}">
          <button class="action-btn wrong" bindtap="submitAnswer" data-correct="false">ç­”é”™äº†</button>
          <button class="action-btn correct" bindtap="submitAnswer" data-correct="true">ç­”å¯¹äº†</button>
        </view>
      </view>

      <!-- å¯¼èˆªæŒ‰é’® -->
      <view class="navigation-buttons">
        <button class="nav-btn" bindtap="prevQuestion" disabled="{{currentIndex === 0}}">
          <text class="nav-icon">â€¹</text>
          <text class="nav-text">ä¸Šä¸€é¢˜</text>
        </button>
        <button class="nav-btn" bindtap="nextQuestion" disabled="{{currentIndex === reviewMistakes.length - 1}}">
          <text class="nav-text">ä¸‹ä¸€é¢˜</text>
          <text class="nav-icon">â€º</text>
        </button>
      </view>
    </view>
  </view>

  <!-- å®ŒæˆçŠ¶æ€ -->
  <view class="completion-container" wx:if="{{isCompleted}}">
    <view class="completion-icon">ğŸ‰</view>
    <view class="completion-title">å¤ä¹ å®Œæˆï¼</view>
    <view class="completion-stats">
      <view class="stat-item">
        <view class="stat-number">{{reviewProgress.total}}</view>
        <view class="stat-label">æ€»é¢˜æ•°</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{reviewProgress.correct}}</view>
        <view class="stat-label">ç­”å¯¹</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{reviewProgress.wrong}}</view>
        <view class="stat-label">ç­”é”™</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{Math.round((reviewProgress.correct / reviewProgress.total) * 100)}}%</view>
        <view class="stat-label">æ­£ç¡®ç‡</view>
      </view>
    </view>

    <view class="completion-actions">
      <button class="action-btn secondary" bindtap="restartReview">å†æ¬¡å¤ä¹ </button>
      <button class="action-btn primary" bindtap="exitReview">è¿”å›</button>
    </view>
  </view>

  <!-- ç§‘ç›®é€‰æ‹©å™¨å¼¹çª— -->
  <view class="subject-selector-overlay" wx:if="{{showSubjectSelector}}" bindtap="hideSubjectSelector">
    <view class="subject-selector-popup" catchtap="">
      <view class="selector-header">
        <text class="selector-title">é€‰æ‹©å¤ä¹ ç§‘ç›®</text>
        <view class="close-btn" bindtap="hideSubjectSelector">âœ•</view>
      </view>
      <view class="subjects-grid">
        <view
          wx:for="{{subjects}}"
          wx:key="name"
          class="subject-option {{selectedSubject === item.name ? 'selected' : ''}}"
          style="border-color: {{item.color}}"
          bindtap="selectSubject"
          data-subject="{{item.name}}"
        >
          <view class="subject-color" style="background-color: {{item.color}}"></view>
          <text class="subject-name">{{item.displayName}}</text>
          <view class="check-icon" wx:if="{{selectedSubject === item.name}}">âœ“</view>
        </view>
      </view>
    </view>
  </view>
</view>