<view class="container" style="--theme-color: {{themeColor}}" wx:if="{{!loading && mistake}}">
  <!-- å¤´éƒ¨ä¿¡æ¯ -->
  <view class="header">
    <view class="subject-info">
      <view class="subject-tag" style="background-color: {{mistake.subjectColor}}">
        {{mistake.subject}}
      </view>
      <view class="chapter-text" wx:if="{{mistake.chapter}}">{{mistake.chapter}}</view>
    </view>

    <view class="header-actions">
      <view class="action-btn star-btn {{mistake.isStarred ? 'starred' : ''}}" bindtap="toggleStar">
        {{mistake.isStarred ? 'â­' : 'â˜†'}}
      </view>
      <view class="action-btn edit-btn" bindtap="editMistake">âœï¸</view>
      <view class="action-btn delete-btn" bindtap="deleteMistake">ğŸ—‘ï¸</view>
      <view class="action-btn share-btn" bindtap="shareMistake">ğŸ“¤</view>
    </view>
  </view>

  <!-- é¢˜ç›®å†…å®¹ -->
  <view class="question-section">
    <view class="section-title">é¢˜ç›®</view>
    <view class="question-content">
      <text class="question-text">{{mistake.question}}</text>
      <view wx:if="{{mistake.questionImage}}" class="question-image" bindtap="previewImage">
        <image src="{{mistake.questionImage}}" mode="widthFix" />
      </view>
    </view>

    <view wx:if="{{mistake.knowledgePoint}}" class="knowledge-point">
      <text class="label">çŸ¥è¯†ç‚¹ï¼š</text>{{mistake.knowledgePoint}}
    </view>

    <view wx:if="{{mistake.tags.length > 0}}" class="tags">
      <block wx:for="{{mistake.tags}}" wx:key="*this" wx:for-item="tag">
        <text class="tag">{{tag}}</text>
      </block>
    </view>
  </view>

  <!-- å¤ä¹ æ¨¡å¼ -->
  <view class="review-section" wx:if="{{reviewMode && !showAnswer}}">
    <view class="section-title">å¤ä¹ ç­”é¢˜</view>
    <textarea
      class="answer-input"
      placeholder="è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ..."
      value="{{userAnswer}}"
      bindinput="onAnswerInput"
      maxlength="500"
    />
    <view class="review-actions">
      <button class="review-btn correct" bindtap="submitReview" data-correct="{{true}}">
        âœ“ ç­”å¯¹äº†
      </button>
      <button class="review-btn wrong" bindtap="submitReview" data-correct="{{false}}">
        âœ— ç­”é”™äº†
      </button>
    </view>
  </view>

  <!-- æˆ‘çš„ç­”æ¡ˆ -->
  <view class="answer-section" wx:if="{{mistake.myAnswer}}">
    <view class="section-title">æˆ‘çš„ç­”æ¡ˆ</view>
    <view class="answer-content wrong-answer">
      {{mistake.myAnswer}}
    </view>
  </view>

  <!-- æ­£ç¡®ç­”æ¡ˆ -->
  <view class="answer-section">
    <view class="section-title" bindtap="toggleAnswer">
      <text>æ­£ç¡®ç­”æ¡ˆ</text>
      <text class="toggle-icon">{{showAnswer ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}}</text>
    </view>
    <view class="answer-content correct-answer" wx:if="{{showAnswer}}">
      {{mistake.correctAnswer}}
    </view>
    <view class="answer-placeholder" wx:else bindtap="toggleAnswer">
      ç‚¹å‡»æŸ¥çœ‹æ­£ç¡®ç­”æ¡ˆ
    </view>
  </view>

  <!-- è§£æè¯´æ˜ -->
  <view class="explanation-section" wx:if="{{mistake.explanation}}">
    <view class="section-title" bindtap="toggleExplanation">
      <text>è§£æè¯´æ˜</text>
      <text class="toggle-icon">{{showExplanation ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}}</text>
    </view>
    <view class="explanation-content" wx:if="{{showExplanation}}">
      {{mistake.explanation}}
    </view>
    <view class="explanation-placeholder" wx:else bindtap="toggleExplanation">
      ç‚¹å‡»æŸ¥çœ‹è§£æè¯´æ˜
    </view>
  </view>

  <!-- é”™é¢˜çŠ¶æ€ -->
  <view class="status-section">
    <view class="section-title">é”™é¢˜çŠ¶æ€</view>

    <view class="status-grid">
      <view class="status-item">
        <view class="status-label">éš¾åº¦ç­‰çº§</view>
        <view class="difficulty-display">
          <block wx:for="{{[1,2,3,4,5]}}" wx:key="*this" wx:for-item="star">
            <text class="star {{star <= mistake.difficulty ? 'filled' : ''}}">â˜…</text>
          </block>
        </view>
      </view>

      <view class="status-item">
        <view class="status-label">æŒæ¡ç¨‹åº¦</view>
        <view class="mastery-display">
          <view class="mastery-level" style="color: {{getMasteryColor(mistake.masteryLevel)}}">
            {{getMasteryText(mistake.masteryLevel)}}
          </view>
          <view class="mastery-stars">
            <block wx:for="{{[1,2,3,4,5]}}" wx:key="*this" wx:for-item="star">
              <text class="star {{star <= mistake.masteryLevel ? 'filled' : ''}}">â˜…</text>
            </block>
          </view>
        </view>
      </view>

      <view class="status-item">
        <view class="status-label">å¤ä¹ æ¬¡æ•°</view>
        <view class="status-value">{{mistake.reviewTimes}}æ¬¡</view>
      </view>

      <view class="status-item">
        <view class="status-label">åˆ›å»ºæ—¶é—´</view>
        <view class="status-value">{{formatTime(mistake.createTime)}}</view>
      </view>

      <view class="status-item" wx:if="{{mistake.lastReviewTime}}">
        <view class="status-label">ä¸Šæ¬¡å¤ä¹ </view>
        <view class="status-value">{{formatTime(mistake.lastReviewTime)}}</view>
      </view>

      <view class="status-item">
        <view class="status-label">ä¸‹æ¬¡å¤ä¹ </view>
        <view class="status-value">{{getNextReviewText(mistake.nextReviewTime)}}</view>
      </view>
    </view>
  </view>

  <!-- å¤ä¹ å†å² -->
  <view class="history-section" wx:if="{{mistake.reviewHistory.length > 0}}">
    <view class="section-title">å¤ä¹ å†å²</view>
    <view class="history-list">
      <block wx:for="{{mistake.reviewHistory}}" wx:key="date" wx:for-item="record">
        <view class="history-item">
          <view class="history-date">{{formatTime(record.date)}}</view>
          <view class="history-result {{record.result}}">
            {{record.result === 'correct' ? 'âœ“ æ­£ç¡®' : 'âœ— é”™è¯¯'}}
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œ -->
  <view class="bottom-actions" wx:if="{{!reviewMode}}">
    <button class="action-button primary" bindtap="editMistake">ç¼–è¾‘é”™é¢˜</button>
    <button class="action-button secondary" bindtap="submitReview" data-correct="{{false}}">æ ‡è®°ä¸ºéœ€å¤ä¹ </button>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view wx:if="{{loading}}" class="loading-container">
  <view class="loading-spinner"></view>
  <text class="loading-text">åŠ è½½ä¸­...</text>
</view>

<!-- é”™è¯¯çŠ¶æ€ -->
<view wx:if="{{!loading && !mistake}}" class="error-container">
  <view class="error-icon">âŒ</view>
  <text class="error-text">é”™é¢˜ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</text>
  <button class="back-btn" bindtap="navigateBack">è¿”å›</button>
</view>