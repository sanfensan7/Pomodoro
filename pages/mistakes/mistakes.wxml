<view class="container fade-in" style="--theme-color: {{themeColor}}">
  <!-- 头部统计卡片 -->
  <view class="header-stats slide-up">
    <view class="stats-card" bindtap="viewStats">
      <view class="stats-icon">📚</view>
      <view class="stats-content">
        <view class="stats-number">{{stats.totalMistakes || 0}}</view>
        <view class="stats-label">总错题</view>
      </view>
    </view>
    <view class="stats-card" bindtap="startReview">
      <view class="stats-icon">⏰</view>
      <view class="stats-content">
        <view class="stats-number">{{stats.reviewStats.needReview || 0}}</view>
        <view class="stats-label">待复习</view>
      </view>
    </view>
    <view class="stats-card" bindtap="viewStats">
      <view class="stats-icon">✅</view>
      <view class="stats-content">
        <view class="stats-number">{{stats.reviewStats.totalReviews || 0}}</view>
        <view class="stats-label">已复习</view>
      </view>
    </view>
  </view>

  <!-- 热力图区域 -->
  <view class="heatmap-section card">
    <view class="section-header">
      <view class="section-title">
        <text class="title-icon">🔥</text>
        <text class="title-text">学习热力图</text>
      </view>
      <view class="section-subtitle">{{heatmapSubtitle}}</view>
    </view>

    <!-- 学习统计图表 -->
    <view class="stats-container">
      <!-- 月度统计柱状图 -->
      <view class="monthly-chart">
        <view class="chart-title">📊 近6个月学习统计</view>
        <view wx:if="{{monthlyStats.length > 0}}" class="chart-bars">
          <view
            wx:for="{{monthlyStats}}"
            wx:key="month"
            class="chart-bar-container"
          >
            <view class="chart-bar">
              <view
                class="bar-fill"
                style="height: {{item.percentage}}%; background: linear-gradient(to top, {{themeColor}}, rgba({{themeColorRgb}}, 0.6))"
              ></view>
            </view>
            <view class="bar-label">{{item.label}}</view>
            <view class="bar-value">{{item.total}}</view>
          </view>
        </view>
        <!-- 空状态 -->
        <view wx:else class="chart-empty">
          <view class="empty-icon">📈</view>
          <view class="empty-text">暂无统计数据</view>
          <view class="empty-desc">添加错题后即可查看学习统计</view>
        </view>
      </view>

      <!-- 学习日历 -->
      <view class="learning-calendar">
        <view class="calendar-title">📅 本月学习日历</view>
        <view wx:if="{{calendarDays.length > 0}}" class="calendar-grid">
          <view
            wx:for="{{calendarDays}}"
            wx:key="date"
            class="calendar-day {{item.hasData ? 'has-data' : ''}} {{item.isToday ? 'today' : ''}} {{item.isCurrentMonth ? '' : 'other-month'}}"
            data-date="{{item.date}}"
            bindtap="onCalendarDayTap"
          >
            <view class="day-number">{{item.day}}</view>
            <view wx:if="{{item.hasData}}" class="day-indicator">
              <view class="indicator-dot" style="background-color: {{themeColor}}"></view>
            </view>
          </view>
        </view>
        <!-- 空状态 -->
        <view wx:else class="calendar-empty">
          <view class="empty-icon">📚</view>
          <view class="empty-text">还没有学习记录</view>
          <view class="empty-desc">开始添加错题来记录学习进度吧</view>
        </view>
      </view>

      <!-- 学习连击 -->
      <view class="streak-container">
        <view class="streak-card">
          <view class="streak-icon">🔥</view>
          <view class="streak-info">
            <view class="streak-number">{{currentStreak}}</view>
            <view class="streak-label">连续学习天数</view>
          </view>
        </view>
        <view class="streak-card">
          <view class="streak-icon">⭐</view>
          <view class="streak-info">
            <view class="streak-number">{{maxStreak}}</view>
            <view class="streak-label">最长连击记录</view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 搜索和筛选 -->
  <view class="search-filter-bar card">
    <view class="search-box">
      <view class="search-icon">🔍</view>
      <input
        placeholder="搜索错题内容、科目、标签..."
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        class="search-input"
      />
    </view>
    <button class="filter-btn {{showFilterMenu ? 'active' : ''}}" bindtap="toggleFilterMenu">
      <text class="filter-icon">🎛️</text>
      <text class="filter-text">筛选</text>
      <view class="filter-dot" wx:if="{{currentFilter !== 'all'}}"></view>
    </button>
  </view>

  <!-- 筛选菜单 -->
  <view class="filter-menu {{showFilterMenu ? 'show' : ''}}" bindtap="closeFilterMenu">
    <view class="filter-content" catchtap="stopPropagation">
      <view class="filter-header">
        <text class="filter-header-title">筛选条件</text>
        <button class="filter-close" bindtap="closeFilterMenu">✕</button>
      </view>

      <view class="filter-section">
        <view class="filter-title">
          <text class="filter-title-icon">📋</text>
          <text>筛选类型</text>
        </view>
        <view class="filter-options">
          <button class="filter-option {{currentFilter === 'all' ? 'active' : ''}}"
                  bindtap="selectFilter" data-filter="all">
            <text class="option-icon">📚</text>
            <text>全部</text>
          </button>
          <button class="filter-option {{currentFilter === 'review' ? 'active' : ''}}"
                  bindtap="selectFilter" data-filter="review">
            <text class="option-icon">⏰</text>
            <text>待复习</text>
          </button>
          <button class="filter-option {{currentFilter === 'starred' ? 'active' : ''}}"
                  bindtap="selectFilter" data-filter="starred">
            <text class="option-icon">⭐</text>
            <text>已收藏</text>
          </button>
        </view>
      </view>

      <view class="filter-section">
        <view class="filter-title">
          <text class="filter-title-icon">🎯</text>
          <text>按科目</text>
        </view>
        <view class="filter-options subject-grid">
          <button class="filter-option subject-option {{selectedSubject === '' ? 'active' : ''}}"
                  bindtap="selectSubject" data-subject="">
            <text class="option-icon">📖</text>
            <text>全部科目</text>
          </button>
          <block wx:for="{{subjects}}" wx:key="id">
            <button class="filter-option subject-option {{selectedSubject === item.name ? 'active' : ''}}"
                    bindtap="selectSubject" data-subject="{{item.name}}"
                    style="border-color: {{item.color}}; background: {{selectedSubject === item.name ? item.color : 'transparent'}}">
              <text class="subject-name">{{item.name}}</text>
            </button>
          </block>
        </view>
      </view>

      <view class="filter-section">
        <view class="filter-title">
          <text class="filter-title-icon">📊</text>
          <text>按掌握程度</text>
        </view>
        <view class="filter-options mastery-grid">
          <button class="filter-option mastery-option {{selectedMastery === 0 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="0">
            <text class="mastery-icon">📚</text>
            <text>全部</text>
          </button>
          <button class="filter-option mastery-option {{selectedMastery === 1 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="1">
            <text class="mastery-icon">🌱</text>
            <text>初学</text>
          </button>
          <button class="filter-option mastery-option {{selectedMastery === 2 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="2">
            <text class="mastery-icon">🌿</text>
            <text>了解</text>
          </button>
          <button class="filter-option mastery-option {{selectedMastery === 3 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="3">
            <text class="mastery-icon">🌳</text>
            <text>熟悉</text>
          </button>
          <button class="filter-option mastery-option {{selectedMastery === 4 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="4">
            <text class="mastery-icon">🏆</text>
            <text>掌握</text>
          </button>
          <button class="filter-option mastery-option {{selectedMastery === 5 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="5">
            <text class="mastery-icon">👑</text>
            <text>精通</text>
          </button>
        </view>
      </view>

      <view class="filter-actions">
        <button class="filter-action-btn reset" bindtap="resetFilters">重置</button>
        <button class="filter-action-btn apply" bindtap="applyFilters">应用筛选</button>
      </view>
    </view>
  </view>

  <!-- 快速操作按钮 -->
  <view class="quick-actions">
    <button class="action-btn primary" bindtap="addMistake">
      <text class="btn-icon">➕</text>
      <text class="btn-text">添加</text>
    </button>
    <button class="action-btn secondary" bindtap="startReview">
      <text class="btn-icon">📖</text>
      <text class="btn-text">复习</text>
    </button>
    <button class="action-btn secondary" bindtap="manageSubjects">
      <text class="btn-icon">📚</text>
      <text class="btn-text">科目</text>
    </button>
  </view>

  <!-- 错题列表 -->
  <view class="mistakes-list" wx:if="{{!loading}}">
    <view wx:if="{{displayMistakes.length === 0}}" class="empty-state">
      <view class="empty-icon">📝</view>
      <view class="empty-text">
        <block wx:if="{{currentFilter === 'all' && !searchKeyword}}">
          还没有错题记录
          <text class="empty-hint">点击"添加错题"开始记录吧</text>
        </block>
        <block wx:else>
          没有找到相关错题
          <text class="empty-hint">试试调整筛选条件</text>
        </block>
      </view>
    </view>

    <block wx:for="{{displayMistakes}}" wx:key="id">
      <view class="mistake-card" bindtap="viewMistake" data-id="{{item.id}}">
        <!-- 错题头部 -->
        <view class="mistake-header">
          <view class="subject-tag" style="background-color: {{item.subjectColor || themeColor}}">
            {{item.subject}}
          </view>
          <view class="mistake-actions">
            <view class="star-btn {{item.isStarred ? 'starred' : ''}}" 
                  bindtap="toggleStar" data-id="{{item.id}}">
              {{item.isStarred ? '⭐' : '☆'}}
            </view>
            <view class="edit-btn" bindtap="editMistake" data-id="{{item.id}}">✏️</view>
            <view class="delete-btn" bindtap="deleteMistake" data-id="{{item.id}}">🗑️</view>
          </view>
        </view>

        <!-- 错题内容 -->
        <view class="mistake-content">
          <view class="question-text">{{item.question}}</view>
          <view wx:if="{{item.questionImage}}" class="question-image">
            <image src="{{item.questionImage}}" mode="widthFix" />
          </view>
          
          <view wx:if="{{item.knowledgePoint}}" class="knowledge-point">
            <text class="label">知识点：</text>{{item.knowledgePoint}}
          </view>
          
          <view wx:if="{{item.tags.length > 0}}" class="tags">
            <block wx:for="{{item.tags}}" wx:key="*this" wx:for-item="tag">
              <text class="tag">{{tag}}</text>
            </block>
          </view>
        </view>

        <!-- 错题状态 -->
        <view class="mistake-status">
          <view class="mastery-level">
            <text class="mastery-label">掌握程度：</text>
            <view class="mastery-stars">
              <block wx:for="{{[1,2,3,4,5]}}" wx:key="*this" wx:for-item="star">
                <text class="star {{star <= item.masteryLevel ? 'filled' : ''}}">★</text>
              </block>
            </view>
          </view>
          
          <view class="review-info">
            <text class="review-times">复习{{item.reviewTimes}}次</text>
            <text class="create-time">{{item.createTimeText}}</text>
          </view>
        </view>
      </view>
    </block>
    
    <!-- 加载更多提示 -->
    <view class="load-more" wx:if="{{displayMistakes.length > 0}}">
      <view wx:if="{{loadingMore}}" class="loading-more">
        <view class="loading-spinner-small"></view>
        <text>加载中...</text>
      </view>
      <view wx:elif="{{hasMore}}" class="has-more">
        <text>下拉查看更多</text>
      </view>
      <view wx:else class="no-more">
        <text>— 已显示全部 {{displayMistakes.length}} 条 —</text>
      </view>
    </view>
  </view>

  <!-- 添加错题浮动按钮 -->
  <view class="fab" bindtap="addMistake">
    <text class="fab-icon">➕</text>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-state">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>
</view>
