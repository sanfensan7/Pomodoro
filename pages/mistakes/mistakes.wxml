<view class="container fade-in" style="--theme-color: {{themeColor}}">
  <!-- å¤´éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
  <view class="header-stats slide-up">
    <view class="stats-card" bindtap="viewStats">
      <view class="stats-icon">ğŸ“š</view>
      <view class="stats-content">
        <view class="stats-number">{{stats.totalMistakes || 0}}</view>
        <view class="stats-label">æ€»é”™é¢˜</view>
      </view>
    </view>
    <view class="stats-card" bindtap="startReview">
      <view class="stats-icon">â°</view>
      <view class="stats-content">
        <view class="stats-number">{{stats.reviewStats.needReview || 0}}</view>
        <view class="stats-label">å¾…å¤ä¹ </view>
      </view>
    </view>
    <view class="stats-card" bindtap="viewStats">
      <view class="stats-icon">âœ…</view>
      <view class="stats-content">
        <view class="stats-number">{{stats.reviewStats.totalReviews || 0}}</view>
        <view class="stats-label">å·²å¤ä¹ </view>
      </view>
    </view>
  </view>

  <!-- çƒ­åŠ›å›¾åŒºåŸŸ -->
  <view class="heatmap-section card">
    <view class="section-header">
      <view class="section-title">
        <text class="title-icon">ğŸ”¥</text>
        <text class="title-text">å­¦ä¹ çƒ­åŠ›å›¾</text>
      </view>
      <view class="section-subtitle">{{heatmapSubtitle}}</view>
    </view>

    <!-- å­¦ä¹ ç»Ÿè®¡å›¾è¡¨ -->
    <view class="stats-container">
      <!-- æœˆåº¦ç»Ÿè®¡æŸ±çŠ¶å›¾ -->
      <view class="monthly-chart">
        <view class="chart-title">ğŸ“Š è¿‘6ä¸ªæœˆå­¦ä¹ ç»Ÿè®¡</view>
        <view wx:if="{{monthlyStats.length > 0}}" class="chart-bars">
          <view
            wx:for="{{monthlyStats}}"
            wx:key="month"
            class="chart-bar-container"
          >
            <view class="chart-bar">
              <view
                class="bar-fill"
                style="height: {{item.percentage}}%; background: linear-gradient(to top, {{themeColor}}, rgba({{themeColorRgb}}, 0.6))"
              ></view>
            </view>
            <view class="bar-label">{{item.label}}</view>
            <view class="bar-value">{{item.total}}</view>
          </view>
        </view>
        <!-- ç©ºçŠ¶æ€ -->
        <view wx:else class="chart-empty">
          <view class="empty-icon">ğŸ“ˆ</view>
          <view class="empty-text">æš‚æ— ç»Ÿè®¡æ•°æ®</view>
          <view class="empty-desc">æ·»åŠ é”™é¢˜åå³å¯æŸ¥çœ‹å­¦ä¹ ç»Ÿè®¡</view>
        </view>
      </view>

      <!-- å­¦ä¹ æ—¥å† -->
      <view class="learning-calendar">
        <view class="calendar-title">ğŸ“… æœ¬æœˆå­¦ä¹ æ—¥å†</view>
        <view wx:if="{{calendarDays.length > 0}}" class="calendar-grid">
          <view
            wx:for="{{calendarDays}}"
            wx:key="date"
            class="calendar-day {{item.hasData ? 'has-data' : ''}} {{item.isToday ? 'today' : ''}} {{item.isCurrentMonth ? '' : 'other-month'}}"
            data-date="{{item.date}}"
            bindtap="onCalendarDayTap"
          >
            <view class="day-number">{{item.day}}</view>
            <view wx:if="{{item.hasData}}" class="day-indicator">
              <view class="indicator-dot" style="background-color: {{themeColor}}"></view>
            </view>
          </view>
        </view>
        <!-- ç©ºçŠ¶æ€ -->
        <view wx:else class="calendar-empty">
          <view class="empty-icon">ğŸ“š</view>
          <view class="empty-text">è¿˜æ²¡æœ‰å­¦ä¹ è®°å½•</view>
          <view class="empty-desc">å¼€å§‹æ·»åŠ é”™é¢˜æ¥è®°å½•å­¦ä¹ è¿›åº¦å§</view>
        </view>
      </view>

      <!-- å­¦ä¹ è¿å‡» -->
      <view class="streak-container">
        <view class="streak-card">
          <view class="streak-icon">ğŸ”¥</view>
          <view class="streak-info">
            <view class="streak-number">{{currentStreak}}</view>
            <view class="streak-label">è¿ç»­å­¦ä¹ å¤©æ•°</view>
          </view>
        </view>
        <view class="streak-card">
          <view class="streak-icon">â­</view>
          <view class="streak-info">
            <view class="streak-number">{{maxStreak}}</view>
            <view class="streak-label">æœ€é•¿è¿å‡»è®°å½•</view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="search-filter-bar card">
    <view class="search-box">
      <view class="search-icon">ğŸ”</view>
      <input
        placeholder="æœç´¢é”™é¢˜å†…å®¹ã€ç§‘ç›®ã€æ ‡ç­¾..."
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        class="search-input"
      />
    </view>
    <button class="filter-btn {{showFilterMenu ? 'active' : ''}}" bindtap="toggleFilterMenu">
      <text class="filter-icon">ğŸ›ï¸</text>
      <text class="filter-text">ç­›é€‰</text>
      <view class="filter-dot" wx:if="{{currentFilter !== 'all'}}"></view>
    </button>
  </view>

  <!-- ç­›é€‰èœå• -->
  <view class="filter-menu {{showFilterMenu ? 'show' : ''}}" bindtap="closeFilterMenu">
    <view class="filter-content" catchtap="stopPropagation">
      <view class="filter-header">
        <text class="filter-header-title">ç­›é€‰æ¡ä»¶</text>
        <button class="filter-close" bindtap="closeFilterMenu">âœ•</button>
      </view>

      <view class="filter-section">
        <view class="filter-title">
          <text class="filter-title-icon">ğŸ“‹</text>
          <text>ç­›é€‰ç±»å‹</text>
        </view>
        <view class="filter-options">
          <button class="filter-option {{currentFilter === 'all' ? 'active' : ''}}"
                  bindtap="selectFilter" data-filter="all">
            <text class="option-icon">ğŸ“š</text>
            <text>å…¨éƒ¨</text>
          </button>
          <button class="filter-option {{currentFilter === 'review' ? 'active' : ''}}"
                  bindtap="selectFilter" data-filter="review">
            <text class="option-icon">â°</text>
            <text>å¾…å¤ä¹ </text>
          </button>
          <button class="filter-option {{currentFilter === 'starred' ? 'active' : ''}}"
                  bindtap="selectFilter" data-filter="starred">
            <text class="option-icon">â­</text>
            <text>å·²æ”¶è—</text>
          </button>
        </view>
      </view>

      <view class="filter-section">
        <view class="filter-title">
          <text class="filter-title-icon">ğŸ¯</text>
          <text>æŒ‰ç§‘ç›®</text>
        </view>
        <view class="filter-options subject-grid">
          <button class="filter-option subject-option {{selectedSubject === '' ? 'active' : ''}}"
                  bindtap="selectSubject" data-subject="">
            <text class="option-icon">ğŸ“–</text>
            <text>å…¨éƒ¨ç§‘ç›®</text>
          </button>
          <block wx:for="{{subjects}}" wx:key="id">
            <button class="filter-option subject-option {{selectedSubject === item.name ? 'active' : ''}}"
                    bindtap="selectSubject" data-subject="{{item.name}}"
                    style="border-color: {{item.color}}; background: {{selectedSubject === item.name ? item.color : 'transparent'}}">
              <text class="subject-name">{{item.name}}</text>
            </button>
          </block>
        </view>
      </view>

      <view class="filter-section">
        <view class="filter-title">
          <text class="filter-title-icon">ğŸ“Š</text>
          <text>æŒ‰æŒæ¡ç¨‹åº¦</text>
        </view>
        <view class="filter-options mastery-grid">
          <button class="filter-option mastery-option {{selectedMastery === 0 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="0">
            <text class="mastery-icon">ğŸ“š</text>
            <text>å…¨éƒ¨</text>
          </button>
          <button class="filter-option mastery-option {{selectedMastery === 1 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="1">
            <text class="mastery-icon">ğŸŒ±</text>
            <text>åˆå­¦</text>
          </button>
          <button class="filter-option mastery-option {{selectedMastery === 2 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="2">
            <text class="mastery-icon">ğŸŒ¿</text>
            <text>äº†è§£</text>
          </button>
          <button class="filter-option mastery-option {{selectedMastery === 3 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="3">
            <text class="mastery-icon">ğŸŒ³</text>
            <text>ç†Ÿæ‚‰</text>
          </button>
          <button class="filter-option mastery-option {{selectedMastery === 4 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="4">
            <text class="mastery-icon">ğŸ†</text>
            <text>æŒæ¡</text>
          </button>
          <button class="filter-option mastery-option {{selectedMastery === 5 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="5">
            <text class="mastery-icon">ğŸ‘‘</text>
            <text>ç²¾é€š</text>
          </button>
        </view>
      </view>

      <view class="filter-actions">
        <button class="filter-action-btn reset" bindtap="resetFilters">é‡ç½®</button>
        <button class="filter-action-btn apply" bindtap="applyFilters">åº”ç”¨ç­›é€‰</button>
      </view>
    </view>
  </view>

  <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
  <view class="quick-actions">
    <button class="action-btn primary" bindtap="addMistake">
      <text class="btn-icon">â•</text>
      <text class="btn-text">æ·»åŠ </text>
    </button>
    <button class="action-btn secondary" bindtap="startReview">
      <text class="btn-icon">ğŸ“–</text>
      <text class="btn-text">å¤ä¹ </text>
    </button>
    <button class="action-btn secondary" bindtap="manageSubjects">
      <text class="btn-icon">ğŸ“š</text>
      <text class="btn-text">ç§‘ç›®</text>
    </button>
  </view>

  <!-- é”™é¢˜åˆ—è¡¨ -->
  <view class="mistakes-list" wx:if="{{!loading}}">
    <view wx:if="{{displayMistakes.length === 0}}" class="empty-state">
      <view class="empty-icon">ğŸ“</view>
      <view class="empty-text">
        <block wx:if="{{currentFilter === 'all' && !searchKeyword}}">
          è¿˜æ²¡æœ‰é”™é¢˜è®°å½•
          <text class="empty-hint">ç‚¹å‡»"æ·»åŠ é”™é¢˜"å¼€å§‹è®°å½•å§</text>
        </block>
        <block wx:else>
          æ²¡æœ‰æ‰¾åˆ°ç›¸å…³é”™é¢˜
          <text class="empty-hint">è¯•è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶</text>
        </block>
      </view>
    </view>

    <block wx:for="{{displayMistakes}}" wx:key="id">
      <view class="mistake-card" bindtap="viewMistake" data-id="{{item.id}}">
        <!-- é”™é¢˜å¤´éƒ¨ -->
        <view class="mistake-header">
          <view class="subject-tag" style="background-color: {{item.subjectColor || themeColor}}">
            {{item.subject}}
          </view>
          <view class="mistake-actions">
            <view class="star-btn {{item.isStarred ? 'starred' : ''}}" 
                  bindtap="toggleStar" data-id="{{item.id}}">
              {{item.isStarred ? 'â­' : 'â˜†'}}
            </view>
            <view class="edit-btn" bindtap="editMistake" data-id="{{item.id}}">âœï¸</view>
            <view class="delete-btn" bindtap="deleteMistake" data-id="{{item.id}}">ğŸ—‘ï¸</view>
          </view>
        </view>

        <!-- é”™é¢˜å†…å®¹ -->
        <view class="mistake-content">
          <view class="question-text">{{item.question}}</view>
          <view wx:if="{{item.questionImage}}" class="question-image">
            <image src="{{item.questionImage}}" mode="widthFix" />
          </view>
          
          <view wx:if="{{item.knowledgePoint}}" class="knowledge-point">
            <text class="label">çŸ¥è¯†ç‚¹ï¼š</text>{{item.knowledgePoint}}
          </view>
          
          <view wx:if="{{item.tags.length > 0}}" class="tags">
            <block wx:for="{{item.tags}}" wx:key="*this" wx:for-item="tag">
              <text class="tag">{{tag}}</text>
            </block>
          </view>
        </view>

        <!-- é”™é¢˜çŠ¶æ€ -->
        <view class="mistake-status">
          <view class="mastery-level">
            <text class="mastery-label">æŒæ¡ç¨‹åº¦ï¼š</text>
            <view class="mastery-stars">
              <block wx:for="{{[1,2,3,4,5]}}" wx:key="*this" wx:for-item="star">
                <text class="star {{star <= item.masteryLevel ? 'filled' : ''}}">â˜…</text>
              </block>
            </view>
          </view>
          
          <view class="review-info">
            <text class="review-times">å¤ä¹ {{item.reviewTimes}}æ¬¡</text>
            <text class="create-time">{{item.createTimeText}}</text>
          </view>
        </view>
      </view>
    </block>
    
    <!-- åŠ è½½æ›´å¤šæç¤º -->
    <view class="load-more" wx:if="{{displayMistakes.length > 0}}">
      <view wx:if="{{loadingMore}}" class="loading-more">
        <view class="loading-spinner-small"></view>
        <text>åŠ è½½ä¸­...</text>
      </view>
      <view wx:elif="{{hasMore}}" class="has-more">
        <text>ä¸‹æ‹‰æŸ¥çœ‹æ›´å¤š</text>
      </view>
      <view wx:else class="no-more">
        <text>â€” å·²æ˜¾ç¤ºå…¨éƒ¨ {{displayMistakes.length}} æ¡ â€”</text>
      </view>
    </view>
  </view>

  <!-- æ·»åŠ é”™é¢˜æµ®åŠ¨æŒ‰é’® -->
  <view class="fab" bindtap="addMistake">
    <text class="fab-icon">â•</text>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-state">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>
