<view class="container fade-in" style="--theme-color: {{themeColor}}">
  <!-- å¤´éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
  <view class="header-stats slide-up">
    <view class="stats-card" bindtap="viewStats">
      <view class="stats-icon">ğŸ“š</view>
      <view class="stats-content">
        <view class="stats-number">{{stats.totalMistakes || 0}}</view>
        <view class="stats-label">æ€»é”™é¢˜</view>
      </view>
    </view>
    <view class="stats-card" bindtap="startReview">
      <view class="stats-icon">â°</view>
      <view class="stats-content">
        <view class="stats-number">{{stats.reviewStats.needReview || 0}}</view>
        <view class="stats-label">å¾…å¤ä¹ </view>
      </view>
    </view>
    <view class="stats-card" bindtap="viewStats">
      <view class="stats-icon">âœ…</view>
      <view class="stats-content">
        <view class="stats-number">{{stats.reviewStats.totalReviews || 0}}</view>
        <view class="stats-label">å·²å¤ä¹ </view>
      </view>
    </view>
  </view>

  <!-- çƒ­åŠ›å›¾åŒºåŸŸ -->
  <view class="heatmap-section card">
    <view class="section-header">
      <view class="section-title">
        <text class="title-icon">ğŸ”¥</text>
        <text class="title-text">å­¦ä¹ çƒ­åŠ›å›¾</text>
      </view>
      <view class="section-subtitle">{{heatmapSubtitle}}</view>
    </view>

    <!-- çƒ­åŠ›å›¾ç½‘æ ¼ -->
    <view class="heatmap-container">
      <view class="heatmap-grid">
        <view
          wx:for="{{heatmapGridData}}"
          wx:key="date"
          class="heatmap-cell level-{{item.level}}"
          data-date="{{item.date}}"
          data-count="{{item.count}}"
          data-details="{{item.details}}"
          bindtap="onHeatmapDayTap"
        ></view>
      </view>

      <!-- çƒ­åŠ›å›¾å›¾ä¾‹ -->
      <view class="heatmap-legend">
        <text class="legend-text">å°‘</text>
        <view class="legend-levels">
          <view class="legend-cell level-0"></view>
          <view class="legend-cell level-1"></view>
          <view class="legend-cell level-2"></view>
          <view class="legend-cell level-3"></view>
          <view class="legend-cell level-4"></view>
        </view>
        <text class="legend-text">å¤š</text>
      </view>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="search-filter-bar card">
    <view class="search-box">
      <view class="search-icon">ğŸ”</view>
      <input
        placeholder="æœç´¢é”™é¢˜å†…å®¹ã€ç§‘ç›®ã€æ ‡ç­¾..."
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        class="search-input"
      />
    </view>
    <button class="filter-btn {{showFilterMenu ? 'active' : ''}}" bindtap="toggleFilterMenu">
      <text class="filter-icon">ğŸ›ï¸</text>
      <text class="filter-text">ç­›é€‰</text>
      <view class="filter-dot" wx:if="{{currentFilter !== 'all'}}"></view>
    </button>
  </view>

  <!-- ç­›é€‰èœå• -->
  <view class="filter-menu {{showFilterMenu ? 'show' : ''}}" bindtap="closeFilterMenu">
    <view class="filter-content" catchtap="stopPropagation">
      <view class="filter-header">
        <text class="filter-header-title">ç­›é€‰æ¡ä»¶</text>
        <button class="filter-close" bindtap="closeFilterMenu">âœ•</button>
      </view>

      <view class="filter-section">
        <view class="filter-title">
          <text class="filter-title-icon">ğŸ“‹</text>
          <text>ç­›é€‰ç±»å‹</text>
        </view>
        <view class="filter-options">
          <button class="filter-option {{currentFilter === 'all' ? 'active' : ''}}"
                  bindtap="selectFilter" data-filter="all">
            <text class="option-icon">ğŸ“š</text>
            <text>å…¨éƒ¨</text>
          </button>
          <button class="filter-option {{currentFilter === 'review' ? 'active' : ''}}"
                  bindtap="selectFilter" data-filter="review">
            <text class="option-icon">â°</text>
            <text>å¾…å¤ä¹ </text>
          </button>
          <button class="filter-option {{currentFilter === 'starred' ? 'active' : ''}}"
                  bindtap="selectFilter" data-filter="starred">
            <text class="option-icon">â­</text>
            <text>å·²æ”¶è—</text>
          </button>
        </view>
      </view>

      <view class="filter-section">
        <view class="filter-title">
          <text class="filter-title-icon">ğŸ¯</text>
          <text>æŒ‰ç§‘ç›®</text>
        </view>
        <view class="filter-options subject-grid">
          <button class="filter-option subject-option {{selectedSubject === '' ? 'active' : ''}}"
                  bindtap="selectSubject" data-subject="">
            <text class="option-icon">ğŸ“–</text>
            <text>å…¨éƒ¨ç§‘ç›®</text>
          </button>
          <block wx:for="{{subjects}}" wx:key="id">
            <button class="filter-option subject-option {{selectedSubject === item.name ? 'active' : ''}}"
                    bindtap="selectSubject" data-subject="{{item.name}}"
                    style="border-color: {{item.color}}; background: {{selectedSubject === item.name ? item.color : 'transparent'}}">
              <text class="subject-name">{{item.name}}</text>
            </button>
          </block>
        </view>
      </view>

      <view class="filter-section">
        <view class="filter-title">
          <text class="filter-title-icon">ğŸ“Š</text>
          <text>æŒ‰æŒæ¡ç¨‹åº¦</text>
        </view>
        <view class="filter-options mastery-grid">
          <button class="filter-option mastery-option {{selectedMastery === 0 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="0">
            <text class="mastery-icon">ğŸ“š</text>
            <text>å…¨éƒ¨</text>
          </button>
          <button class="filter-option mastery-option {{selectedMastery === 1 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="1">
            <text class="mastery-icon">ğŸŒ±</text>
            <text>åˆå­¦</text>
          </button>
          <button class="filter-option mastery-option {{selectedMastery === 2 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="2">
            <text class="mastery-icon">ğŸŒ¿</text>
            <text>äº†è§£</text>
          </button>
          <button class="filter-option mastery-option {{selectedMastery === 3 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="3">
            <text class="mastery-icon">ğŸŒ³</text>
            <text>ç†Ÿæ‚‰</text>
          </button>
          <button class="filter-option mastery-option {{selectedMastery === 4 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="4">
            <text class="mastery-icon">ğŸ†</text>
            <text>æŒæ¡</text>
          </button>
          <button class="filter-option mastery-option {{selectedMastery === 5 ? 'active' : ''}}"
                  bindtap="selectMastery" data-mastery="5">
            <text class="mastery-icon">ğŸ‘‘</text>
            <text>ç²¾é€š</text>
          </button>
        </view>
      </view>

      <view class="filter-actions">
        <button class="filter-action-btn reset" bindtap="resetFilters">é‡ç½®</button>
        <button class="filter-action-btn apply" bindtap="applyFilters">åº”ç”¨ç­›é€‰</button>
      </view>
    </view>
  </view>

  <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
  <view class="quick-actions">
    <button class="action-btn primary" bindtap="addMistake">
      <text class="btn-icon">â•</text>
      <text class="btn-text">æ·»åŠ </text>
    </button>
    <button class="action-btn secondary" bindtap="startReview">
      <text class="btn-icon">ğŸ“–</text>
      <text class="btn-text">å¤ä¹ </text>
    </button>
    <button class="action-btn secondary" bindtap="manageSubjects">
      <text class="btn-icon">ğŸ“š</text>
      <text class="btn-text">ç§‘ç›®</text>
    </button>
  </view>

  <!-- é”™é¢˜åˆ—è¡¨ -->
  <view class="mistakes-list" wx:if="{{!loading}}">
    <view wx:if="{{filteredMistakes.length === 0}}" class="empty-state">
      <view class="empty-icon">ğŸ“</view>
      <view class="empty-text">
        <block wx:if="{{currentFilter === 'all' && !searchKeyword}}">
          è¿˜æ²¡æœ‰é”™é¢˜è®°å½•
          <text class="empty-hint">ç‚¹å‡»"æ·»åŠ é”™é¢˜"å¼€å§‹è®°å½•å§</text>
        </block>
        <block wx:else>
          æ²¡æœ‰æ‰¾åˆ°ç›¸å…³é”™é¢˜
          <text class="empty-hint">è¯•è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶</text>
        </block>
      </view>
    </view>

    <block wx:for="{{filteredMistakes}}" wx:key="id">
      <view class="mistake-card" bindtap="viewMistake" data-id="{{item.id}}">
        <!-- é”™é¢˜å¤´éƒ¨ -->
        <view class="mistake-header">
          <view class="subject-tag" style="background-color: {{item.subjectColor || themeColor}}">
            {{item.subject}}
          </view>
          <view class="mistake-actions">
            <view class="star-btn {{item.isStarred ? 'starred' : ''}}" 
                  bindtap="toggleStar" data-id="{{item.id}}">
              {{item.isStarred ? 'â­' : 'â˜†'}}
            </view>
            <view class="edit-btn" bindtap="editMistake" data-id="{{item.id}}">âœï¸</view>
            <view class="delete-btn" bindtap="deleteMistake" data-id="{{item.id}}">ğŸ—‘ï¸</view>
          </view>
        </view>

        <!-- é”™é¢˜å†…å®¹ -->
        <view class="mistake-content">
          <view class="question-text">{{item.question}}</view>
          <view wx:if="{{item.questionImage}}" class="question-image">
            <image src="{{item.questionImage}}" mode="widthFix" />
          </view>
          
          <view wx:if="{{item.knowledgePoint}}" class="knowledge-point">
            <text class="label">çŸ¥è¯†ç‚¹ï¼š</text>{{item.knowledgePoint}}
          </view>
          
          <view wx:if="{{item.tags.length > 0}}" class="tags">
            <block wx:for="{{item.tags}}" wx:key="*this" wx:for-item="tag">
              <text class="tag">{{tag}}</text>
            </block>
          </view>
        </view>

        <!-- é”™é¢˜çŠ¶æ€ -->
        <view class="mistake-status">
          <view class="mastery-level">
            <text class="mastery-label">æŒæ¡ç¨‹åº¦ï¼š</text>
            <view class="mastery-stars">
              <block wx:for="{{[1,2,3,4,5]}}" wx:key="*this" wx:for-item="star">
                <text class="star {{star <= item.masteryLevel ? 'filled' : ''}}">â˜…</text>
              </block>
            </view>
          </view>
          
          <view class="review-info">
            <text class="review-times">å¤ä¹ {{item.reviewTimes}}æ¬¡</text>
            <text class="create-time">{{item.createTimeText}}</text>
          </view>
        </view>
      </view>
    </block>
  </view>

  <!-- æ·»åŠ é”™é¢˜æµ®åŠ¨æŒ‰é’® -->
  <view class="fab" bindtap="addMistake">
    <text class="fab-icon">â•</text>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-state">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>
