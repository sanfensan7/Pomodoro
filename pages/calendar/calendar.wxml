<view class="container">
  <!-- æœˆä»½åˆ‡æ¢å™¨ -->
  <view class="month-selector card">
    <view class="selector-btn" bindtap="prevMonth">
      <text class="arrow">â—€</text>
    </view>
    <view class="month-display">
      <text class="year">{{currentYear}}å¹´</text>
      <text class="month">{{currentMonth}}æœˆ</text>
    </view>
    <view class="selector-btn" bindtap="nextMonth">
      <text class="arrow">â–¶</text>
    </view>
  </view>

  <!-- æœˆç»Ÿè®¡å¡ç‰‡ -->
  <view class="month-stats-card card">
    <view class="stats-row">
      <view class="stat-box">
        <text class="stat-value" style="color: {{themeColor}}">{{monthStats.focusDays}}</text>
        <text class="stat-label">ä¸“æ³¨å¤©æ•°</text>
      </view>
      <view class="stat-box">
        <text class="stat-value" style="color: {{themeColor}}">{{monthStats.totalMinutes}}</text>
        <text class="stat-label">æ€»åˆ†é’Ÿæ•°</text>
      </view>
      <view class="stat-box">
        <text class="stat-value" style="color: {{themeColor}}">{{monthStats.avgMinutes}}</text>
        <text class="stat-label">å¹³å‡åˆ†é’Ÿ</text>
      </view>
    </view>
  </view>

  <!-- æ—¥å†ä¸»ä½“ -->
  <view class="calendar-card card">
    <view class="calendar-header">
      <text class="calendar-title">ğŸ“… å­¦ä¹ çƒ­åŠ›å›¾</text>
      <text class="today-btn" bindtap="goToToday">ä»Šå¤©</text>
    </view>

    <!-- æ˜ŸæœŸæ ‡é¢˜ -->
    <view class="week-days">
      <view class="week-day" wx:for="{{weekDays}}" wx:key="index">{{item}}</view>
    </view>

    <!-- æ—¥å†æ ¼å­ -->
    <view class="calendar-grid">
      <view class="calendar-cell {{item.isEmpty ? 'empty' : ''}} {{item.isToday ? 'today' : ''}}"
            wx:for="{{calendar}}"
            wx:key="index"
            data-date-str="{{item.dateStr}}"
            bindtap="onDateTap">
        <view class="cell-content" wx:if="{{!item.isEmpty}}">
          <view class="heatmap-block"
                wx:for-item="heatItem"
                wx:for="{{heatmapData}}"
                wx:if="{{heatItem.date === item.dateStr}}"
                wx:key="date"
                style="background-color: {{getHeatmapColor(heatItem.minutes, maxMinutes)}}">
          </view>
          <text class="day-number">{{item.day}}</text>
        </view>
      </view>
    </view>

    <!-- çƒ­åŠ›å›¾å›¾ä¾‹ -->
    <view class="heatmap-legend">
      <text class="legend-label">ä¸“æ³¨å¼ºåº¦ï¼š</text>
      <view class="legend-colors">
        <view class="legend-item">
          <view class="legend-color" style="background-color: #f0f0f0"></view>
          <text class="legend-text">0</text>
        </view>
        <view class="legend-item">
          <view class="legend-color" style="background-color: #ffcdd2"></view>
          <text class="legend-text">ä½</text>
        </view>
        <view class="legend-item">
          <view class="legend-color" style="background-color: #ef9a9a"></view>
          <text class="legend-text">ä¸­</text>
        </view>
        <view class="legend-item">
          <view class="legend-color" style="background-color: #e57373"></view>
          <text class="legend-text">é«˜</text>
        </view>
        <view class="legend-item">
          <view class="legend-color" style="background-color: #f44336"></view>
          <text class="legend-text">å¾ˆé«˜</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ—¥æœŸè¯¦æƒ…å¼¹çª— -->
  <view class="date-detail-overlay {{selectedDate ? 'show' : ''}}" wx:if="{{selectedDate}}" bindtap="closeDateDetail">
    <view class="date-detail-card" catchtap="doNothing">
      <view class="detail-header">
        <text class="detail-date">{{selectedDate}}</text>
        <text class="detail-close" bindtap="closeDateDetail">âœ•</text>
      </view>
      <view class="detail-content">
        <view class="detail-stat">
          <text class="detail-icon">â±ï¸</text>
          <text class="detail-label">ä¸“æ³¨æ—¶é•¿</text>
          <text class="detail-value" style="color: {{themeColor}}">{{selectedDateStats.minutes}} åˆ†é’Ÿ</text>
        </view>
        <view class="detail-stat">
          <text class="detail-icon">ğŸ¯</text>
          <text class="detail-label">å®Œæˆæ¬¡æ•°</text>
          <text class="detail-value" style="color: {{themeColor}}">{{selectedDateStats.count}} æ¬¡</text>
        </view>
      </view>
    </view>
  </view>
</view>

<wxs module="utils">
  var getHeatmapColor = function(minutes, maxMinutes) {
    if (minutes === 0) return '#f0f0f0';
    
    var ratio = minutes / maxMinutes;
    
    if (ratio < 0.25) return '#ffcdd2';
    if (ratio < 0.5) return '#ef9a9a';
    if (ratio < 0.75) return '#e57373';
    return '#f44336';
  };
  
  module.exports = {
    getHeatmapColor: getHeatmapColor
  };
</wxs>


